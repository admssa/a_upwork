node {
    def project = 'devsops-204802'
    def image_name = 'debian'

    stage('checkout') {
        checkout scm
    }

    stage('Get auth') {
    sh "gcloud auth print-access-token | docker login -u oauth2accesstoken --password-stdin https://eu.gcr.io"
    }

    stage('Build image') {
        image = docker.build("${project}/${image_name}", "-f ./vulnerability_scanning/Dockerfile .")
    }



    stage('Push image') {
      docker.withRegistry('https://eu.gcr.io') {
        image.push("${BUILD_NUMBER}")
        image.push("latest")
      }
    }

    stage('get vulnerability scanning') {
        sh "gcloud alpha container images list-tags --show-occurrences eu.gcr.io/${project}/${image_name}"
    }

}