node {
    def project = 'devsops-204802'
    String[] list

   stage('connect kuber'){
        sh ("gcloud container clusters get-credentials dev-kuber --zone europe-west1-d --project ${project}")

    }

    stage ('get images list'){
       list = sh (script:  """kubectl get  deploy --all-namespaces -o=jsonpath='{range .items[*]}{range .spec.template.spec.containers[*]}{.image}{"\\n"}{end}' | grep ${project}""",
                      returnStdout: true).split("\\n")

    }

    stage('get vulnerability number') {


        for (int i = 0; i < list.size(); i++) {
             vNumber = sh (script: """gcloud alpha container images describe ${list[i]} --format="value(package_vulnerability_summary.total_vulnerability_found)" --show-package-vulnerability """,
                           returnStdout: true)

         println "${list[i]} has ${vNumber} errors"

             if ("${vNumber}".toInteger() > 0) {
                println  '[FAILURE] Failed to build'
                currentBuild.result = 'FAILURE'
                return
             }
         }
    }
}